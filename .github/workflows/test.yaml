name: Test

on:
  push:
    branches:
      - main
      - anmol/fix-ci
  pull_request:
    branches:
      - main

jobs:
  test-with-values:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2

      - uses: ./
        with:
          port-forward: true
          values: |
            chains:
            - name: osmosis-1
              type: osmosis
              numValidators: 1
              ports:
                rest: 1313
                rpc: 26653
              resources:
                limits:
                  cpu: "0.5"
                  memory: "1G"
                requests:
                  cpu: "0.2"
                  memory: "500M"
            - name: wasmd
              type: wasmd
              numValidators: 1
              ports:
                rpc: 26659
                rest: 1319
              resources:
                limits:
                  cpu: "0.5"
                  memory: "1G"
                requests:
                  cpu: "0.2"
                  memory: "500M"

      - name: Check kubectl pods
        run: |
          for chain in wasmd osmosis-1; do
            kubectl get pods $chain-genesis-0
          done
        shell: bash

      - name: Check port forwarded status
        run: |
          echo "Curl localhost"
          curl http://localhost:26653/status
          curl http://localhost:26659/status
          echo "Try automated curl..."
          for port in 26659 26653; do
            status_code=$(curl --write-out %{http_code} --silent --output /dev/null http://localhost:$port/status)
            if [[ "$status_code" -ne 200 ]]; then
              echo "Expected status code: 200, got: $status_code, from http://localhost:$port/status"
              exit 1
            fi
          done
        shell: bash

  test-with-remote-cluster:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2

      - name: Setup kind cluster
        if: ${{ inputs.kubeconfig == '' }}
        uses: helm/kind-action@v1.4.0
        with:
          cluster_name: kind-shuttle
          config: /tmp/kubeconfig


      - name: Read kubeconfig
        id: kubeconfig
        uses: juliangruber/read-file-action@v1
        with:
          path: /tmp/kubeconfig

      - uses: ./
        with:
          port-forward: true
          kubeconfig: ${{ steps.kubeconfig.outputs.content }}
          values: |
            chains:
            - name: osmosis-1
              type: osmosis
              numValidators: 2
              ports:
                rest: 1313
                rpc: 26653
              resources:
                limits:
                  cpu: "0.5"
                  memory: "1G"
                requests:
                  cpu: "0.2"
                  memory: "500M"

      - name: Check kubectl pods
        run: |
          kubectl get pods osmosis-1-genesis-0
          kubectl get pods osmosis-1-validator-0
        shell: bash

  test-with-no-portforward:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2

      - uses: ./
        with:
          port-forward: false
          values: |
            chains:
            - name: osmosis-1
              type: osmosis
              numValidators: 1
              resources:
                limits:
                  cpu: "0.5"
                  memory: "1G"
                requests:
                  cpu: "0.2"
                  memory: "500M"
            - name: wasmd
              type: wasmd
              numValidators: 1
              resources:
                limits:
                  cpu: "0.5"
                  memory: "1G"
                requests:
                  cpu: "0.2"
                  memory: "500M"

      - name: Check kubectl pods
        run: |
          for chain in wasmd osmosis-1; do
            kubectl get pods $chain-genesis-0
          done
        shell: bash
